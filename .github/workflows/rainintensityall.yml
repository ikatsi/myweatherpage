name: Rain intensity ALL (manual)

on:
  workflow_dispatch:

concurrency:
  group: rainintensityall
  cancel-in-progress: true

permissions:
  contents: read

jobs:
  run:
    runs-on: ubuntu-latest
    timeout-minutes: 25

    # Copy this env block from tnow.yml EXACTLY (same secret names)
    env:
      FTP_HOST: ${{ secrets.FTP_HOST }}
      FTP_USER: ${{ secrets.FTP_USER }}
      FTP_PASS: ${{ secrets.FTP_PASS }}
      ASSETS_PASS: ${{ secrets.ASSETS_PASS }}
      TZ: Europe/Athens

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.13"
          cache: "pip"

      - name: System dependencies (GDAL/GEOS/PROJ)
        run: |
          sudo apt-get update
          sudo apt-get install -y gdal-bin libgdal-dev

      - name: Install Python deps
        run: |
          python -m pip install --upgrade pip
          if [ -f requirements.txt ]; then
            pip install -r requirements.txt
          else
            pip install numpy pandas geopandas shapely pyproj fiona matplotlib requests
          fi

      # Keep ONLY if your rain intensity scripts need the same encrypted assets as tnow.yml
      - name: Decrypt assets (same as tnow.yml)
        shell: bash
        run: |
          set -euo pipefail
          mkdir -p data

          if [ -f "data/greece.geojson.enc" ]; then
            openssl aes-256-cbc -pbkdf2 -d \
              -in "data/greece.geojson.enc" \
              -out "data/greece.geojson" \
              -pass pass:"$ASSETS_PASS"
          fi

          if [ -f "data/altitude.zip.enc" ]; then
            openssl aes-256-cbc -pbkdf2 -d \
              -in "data/altitude.zip.enc" \
              -out "data/altitude.zip" \
              -pass pass:"$ASSETS_PASS"
            unzip -o "data/altitude.zip" -d "data/"
          fi

      - name: Run ALL rain intensity pipeline
        run: |
          set -euo pipefail
          # CHANGE THIS to your real entrypoint if different:
          python rainintensityall.py
